# Отчёт по анализу спецификации

**Дата**: 2025-11-25  
**Функционал**: 001-nextjs-foundation-setup  
**Проанализированные артефакты**: spec.md, plan.md, tasks.md, constitution.md (v1.5.0)  
**Статус**: Анализ завершён

---

## Краткое содержание

Данный анализ выявил **3 КРИТИЧЕСКИХ проблемы**, **4 проблемы ВЫСОКОЙ серьёзности** и **6 проблем СРЕДНЕЙ серьёзности** в трёх основных артефактах. Наиболее значимая находка — несоответствие между spec.md и constitution.md относительно технологии аутентификации (Passport.js против @supabase/ssr) и версии MUI (v5 против v6).

---

## Таблица обнаруженных проблем

| ID | Категория | Серьёзность | Расположение | Краткое описание | Рекомендация |
|----|-----------|-------------|--------------|------------------|--------------|
| I1 | Несоответствие | КРИТИЧЕСКАЯ | spec.md:L143,279-280,333 vs constitution.md:L255,277 | **Конфликт технологии аутентификации**: spec.md требует Passport.js (FR-043, FR-044), тогда как constitution v1.5.0 указывает пакет @supabase/ssr. Конституция явно указывает, что Passport.js был заменён. | Обновить spec.md, заменив ссылки на Passport.js на @supabase/ssr. Обновить FR-043, FR-044, User Story 7 и Key Entities. |
| I2 | Несоответствие | КРИТИЧЕСКАЯ | spec.md:L168,287 vs constitution.md:L256,287 | **Конфликт версии MUI**: spec.md указывает "MUI v5.x" (FR-048), тогда как constitution v1.5.0 требует "MUI v6.x" с ColorScheme API. | Обновить spec.md FR-048 до "MUI v6.x или последняя стабильная версия" и добавить требование ColorScheme API. |
| I3 | Пробел в покрытии | КРИТИЧЕСКАЯ | spec.md:FR-001-072 vs constitution.md:L250 | **Отсутствует требование Turborepo**: Конституция требует Turborepo для оркестрации сборки, но spec.md НЕ содержит функционального требования для Turborepo. tasks.md содержит T004 для turbo.json. | Добавить FR-073: "Система ДОЛЖНА использовать Turborepo для оркестрации сборки монорепозитория с конфигурацией turbo.json" в spec.md. |
| C1 | Пробел в покрытии | ВЫСОКАЯ | spec.md:FR-001-072 vs constitution.md:L251 | **Отсутствует требование tsdown**: Конституция требует tsdown для двойного вывода CJS+ESM, но spec.md не содержит соответствующего требования. | Добавить FR-074: "Общие пакеты ДОЛЖНЫ использовать tsdown для двойной сборки (CJS + ESM + Types)" в spec.md. |
| C2 | Пробел в покрытии | ВЫСОКАЯ | spec.md:FR-001-072 vs constitution.md:L262 | **Отсутствует требование Husky**: Конституция требует Husky для git hooks, но spec.md говорит только "МОЖЕТ быть настроено" (FR-072). | Изменить FR-072 с "МОЖЕТ быть настроено" на "ДОЛЖНО быть настроено" для соответствия конституции. |
| C3 | Пробел в покрытии | ВЫСОКАЯ | spec.md vs tasks.md | **Нет явного сопоставления FR-к-задачам**: Задачи ссылаются на User Stories (US1-US9), но не на функциональные требования (FR-001-072). Отслеживание покрытия затруднено. | Рассмотреть добавление ссылок FR к задачам или создание матрицы покрытия. |
| C4 | Недоопределённость | ВЫСОКАЯ | spec.md:FR-037-042 | **Абстракция БД размыта**: FR-037-042 упоминают абстракцию базы данных, но не указывают выбор ORM. Конституция рекомендует Prisma (research.md Task 4). | Добавить примечание, что ORM будет выбран в Фазе 2, с Prisma как рекомендованным вариантом согласно research.md. |
| A1 | Неоднозначность | СРЕДНЯЯ | plan.md:L30,35,39,43,47,52,58 | **Неразрешённые маркеры "NEEDS CLARIFICATION"**: Семь пунктов отмечены как требующие уточнения в Key Technology Decisions, хотя research.md утверждает, что они разрешены. | Удалить маркеры "NEEDS CLARIFICATION" из plan.md, так как research.md предоставляет ответы. Добавить примечания "RESOLVED - see research.md". |
| D1 | Дублирование | СРЕДНЯЯ | spec.md:FR-002 + FR-002a + FR-002b | **Избыточные требования packages/ директории**: Три отдельных требования затрагивают структуру директории packages/. | Рассмотреть объединение FR-002, FR-002a, FR-002b в единое комплексное требование с подпунктами. |
| D2 | Дублирование | СРЕДНЯЯ | spec.md:FR-012 + FR-012a + FR-013 + FR-013a | **Избыточные требования структуры пакетов**: Четыре требования затрагивают именование пакетов и директорию base/ с перекрывающимся содержимым. | Рассмотреть объединение в два чётких требования: соглашение об именовании (FR-012) и структура директорий (FR-013). |
| T1 | Дрейф терминологии | СРЕДНЯЯ | spec.md:L333 vs constitution.md:L255 | **"Passport.js-based authentication"**: Раздел Key Entities всё ещё использует терминологию Passport.js, тогда как конституция использует Supabase Auth. | Обновить Key Entities "Authentication Strategy" для ссылки на Supabase Auth с @supabase/ssr. |
| T2 | Дрейф терминологии | СРЕДНЯЯ | tasks.md:T082 | **Смешанная терминология auth**: Задача T082 упоминает "Supabase Auth Helpers", но конституция использует "@supabase/ssr". Должно быть согласовано. | Обновить описание T082, заменив "Supabase Auth Helpers" на "@supabase/ssr". |
| U1 | Недоопределённость | СРЕДНЯЯ | spec.md:FR-053 | **Фреймворк тестирования не указан**: FR-053 говорит "Jest, Vitest, или аналогичный", но конституция указывает Vitest. | Обновить FR-053, указав "Vitest с React Testing Library" согласно конституции. |

---

## Таблица сводки покрытия

| Ключ требования | Есть задача? | ID задач | Примечания |
|-----------------|--------------|----------|------------|
| FR-001 (pnpm-workspace.yaml) | ✅ | T002 | - |
| FR-002 (packages/ директория) | ✅ | T009 | - |
| FR-003 (TypeScript) | ✅ | T005, T033 | - |
| FR-004 (Next.js) | ✅ | T051-T067 | US5 покрывает это |
| FR-005 (двуязычный README) | ✅ | T019, T020 | - |
| FR-007 (.env.example) | ✅ | T008 | - |
| FR-008 (ESLint) | ✅ | T006, T034 | - |
| FR-009 (Prettier) | ✅ | T007, T035 | - |
| FR-010 (.gitignore) | ✅ | T003 | - |
| FR-011 (.github/instructions) | ✅ | T043-T046 | Проверочные задачи |
| FR-012 (именование пакетов) | ✅ | T029 | - |
| FR-013 (base/ директория) | ✅ | T014-T018 | @universo/types |
| FR-014 (корневой package.json) | ✅ | T001 | - |
| FR-037-042 (абстракция БД) | ⚠️ | T074, T075 | Только документация, нет реализации в Фазе 1 |
| FR-043-047 (auth/Passport.js) | ⚠️ | T077-T086 | Задачи используют @supabase/ssr, FR использует Passport.js - КОНФЛИКТ |
| FR-048-052 (MUI) | ✅ | T087-T096 | Но конфликт версий (v5 vs v6) |
| FR-053-058 (тестирование) | ✅ | T097-T108 | - |
| FR-059-063 (конфигурация среды) | ✅ | T068-T076 | - |
| FR-064-067 (безопасность) | ⚠️ | T021 | Только SECURITY.md, нет задачи настройки сканирования |
| FR-068-072 (качество кода) | ✅ | T033-T042 | - |
| **Конституция: Turborepo** | ✅ | T004 | FR не существует - ПРОБЕЛ |
| **Конституция: tsdown** | ❌ | - | Нет FR, нет задачи - ПРОБЕЛ |
| **Конституция: Husky** | ⚠️ | T118 | Опциональная задача, но конституция требует |

---

## Проблемы соответствия конституции

### КРИТИЧЕСКИЕ нарушения

1. **Технология аутентификации (I1)**
   - **Нарушенный принцип**: Technology Stack Requirements
   - **Конституция гласит**: "Authentication: Supabase with @supabase/ssr package (replacing deprecated @supabase/auth-helpers-nextjs)"
   - **Спецификация гласит**: "System MUST include configuration for Passport.js authentication framework"
   - **Решение**: spec.md ДОЛЖЕН быть обновлён для соответствия конституции

2. **Версия MUI (I2)**
   - **Нарушенный принцип**: Technology Stack Requirements
   - **Конституция гласит**: "UI Framework: Material UI (MUI) 6.x or latest stable with ColorScheme API"
   - **Спецификация гласит**: "System MUST include Material UI (MUI) version 5.x or latest stable"
   - **Решение**: spec.md ДОЛЖЕН быть обновлён до v6.x

3. **Оркестрация сборки (I3)**
   - **Нарушенный принцип**: Mandatory Technologies
   - **Конституция гласит**: "Build Orchestration: Turborepo for monorepo build coordination"
   - **Спецификация гласит**: (нет требования)
   - **Решение**: Добавить требование Turborepo в spec.md

---

## Неотображённые задачи

Следующие задачи не имеют чёткого сопоставления с конкретными функциональными требованиями:

| ID задачи | Описание | Предлагаемое FR |
|-----------|----------|-----------------|
| T004 | Create turbo.json | Новое FR-073 (Turborepo) |
| T112 | Add Prisma ORM configuration | Новое FR для Фазы 2, или ссылка в FR-037 |
| T118 | Create .husky/ directory | Обновить FR-072 до MUST |

---

## Метрики

| Метрика | Значение |
|---------|----------|
| **Всего функциональных требований** | 72 (FR-001 до FR-072) |
| **Всего критериев успеха** | 30 (SC-001 до SC-030) |
| **Всего задач** | 121 (T001 до T121) |
| **Пользовательские истории** | 9 (US1 до US9) |
| **Покрытие % (FR с задачами)** | ~90% (грубая оценка) |
| **Количество неоднозначностей** | 7 (маркеры NEEDS CLARIFICATION) |
| **Количество дублирований** | 2 кластера |
| **Критические проблемы** | 3 |
| **Высокие проблемы** | 4 |
| **Средние проблемы** | 6 |
| **Низкие проблемы** | 0 |

---

## Следующие действия

### Необходимо исправить перед имплементацией (КРИТИЧЕСКИЕ)

1. ✅ **I1**: Обновить требования аутентификации spec.md (FR-043, FR-044, User Story 7, Key Entities) для ссылки на @supabase/ssr вместо Passport.js
2. ✅ **I2**: Обновить spec.md FR-048 с "MUI v5.x" на "MUI v6.x или последняя стабильная версия с ColorScheme API"
3. ✅ **I3**: Добавить новое FR-073 для требования Turborepo

### Рекомендуемые улучшения (ВЫСОКИЕ)

4. **C1**: Добавить FR-074 для требования двойной сборки tsdown
5. **C2**: Изменить FR-072 с "MAY" на "MUST" для pre-commit hooks (Husky)
6. **C3**: Создать матрицу трассируемости требований
7. **C4**: Добавить примечание к FR-037-042 о выборе ORM, отложенном до Фазы 2

### Опциональные улучшения (СРЕДНИЕ)

8. **A1**: Очистить маркеры "NEEDS CLARIFICATION" в plan.md
9. **D1, D2**: Рассмотреть объединение избыточных требований
10. **T1, T2**: Исправить дрейф терминологии для согласованности
11. **U1**: Указать Vitest в FR-053

---

## Заключение

Артефакты спецификации в целом хорошо структурированы и всеобъемлющи. Однако существуют **3 критических несоответствия** между spec.md и constitution.md, которые **ДОЛЖНЫ быть разрешены перед имплементацией** для обеспечения соответствия технологическим решениям проекта.

Файл tasks.md имеет правильную структуру (121 задача, правильный формат с чекбоксами, ID задач, маркерами [P] и метками [US#]). Задачи уже соответствуют технологическим решениям конституции (используют @supabase/ssr, паттерны MUI v6) — именно spec.md нуждается в обновлении для соответствия.

**Статус**: ⚠️ Выявлены КРИТИЧЕСКИЕ проблемы — требуются обновления spec.md перед /speckit.implement
